<!DOCTYPE html>

<html>
    <head>
        <meta charset="UTF-8"/>
        <title>Mot de passe oublié - Nooble</title>
        <link rel="stylesheet" href="{{ asset("styles/index.css") }}"/>
        <link rel="icon" type="image/png" href="{{ asset("images/logo.png") }}">
        <script src="{{ asset("scripts/index.js") }}"></script>
    </head>

    <body>
        <div id="login-div" class="center-div">
            <h1>Mot de passe oublié</h1>

            <div class="form-div">
                <h2>Nous sommes désolé d'apprendre cela. </h2>

                <label> Merci d'indiquer votre adresse mail </label>
                <input type="email" id="password-mail"/>

                <span class="result-text" id="password-error-text"></span>

                <button class="main-button" id="password-button">
                    Récupérer mon compte
                </button>

                <a href="/">Me connecter</a>
            </div>
        </div>
    </body>
</html>

{% block javascripts %}
<script type="module">

class ForgotPasswordDiv
{
    constructor(
        mail_input,
        submit_button,
        error_text
    )
    {
        this._mail_input = mail_input;
        this._submit_button = submit_button;
        this._error_text = error_text;

        this._finished = false;

        this._mail_input.addEventListener("input", () => {
            this.onInput()
        });

        this._submit_button.addEventListener("click", () => {
            if (this._finished) return;
            this.onSubmit();
        });

        this.onInput()
    }

    onInput()
    {
        if (this.isValid())
        {
            this._submit_button.removeAttribute("disabled");
        } else {
            this._submit_button.setAttribute("disabled", "");
        }

        this._error_text.innerText = "";
        this._error_text.classList.remove("error");
        this._error_text.classList.remove("success");
    }

    isValid()
    {
        return this._mail_input.value.toLowerCase().match(
            /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
        );
    }

    async onSubmit()
    {
        let mail = this._mail_input.value;

        this._submit_button.setAttribute("disabled", "");

        let data = await fetch(
            "/new-password",
            {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: mail
                })
            }
        );

        switch (data.status )
        {
            case 202:
            let result = await data.json();

            this._finished = true;

            this._error_text.classList.add("success");
            this._error_text.innerText = "Bonjour, " + result.surname + " " + result.name + ". Un mail contenant votre nouveau mot de passe a été envoyé.";
            this._submit_button.textContent = "Retour à la page de connexion";
            this._submit_button.removeAttribute("disabled");
            this._submit_button.addEventListener("click", () => {
                location.href = "/";
            }); 
            break;
        
            case 404:
            this._error_text.classList.add("error");
            this._error_text.innerText = "L'utilisateur n'a pas été trouvé. Veuillez contacter l'administrateur si vous pensez qu'il s'agit d'une erreur";
            break;
        
            default:
            this._error_text.classList.add("error");
            this._error_text.innerText = "An unkown error occured. Please contact your administrator";
            break;
        }
    }
}

window.addEventListener("load", () => {
    let l = new ForgotPasswordDiv(
        document.getElementById("password-mail"),
        document.getElementById("password-button"),
        document.getElementById("password-error-text"),
    );
})

</script>
{% endblock %}
